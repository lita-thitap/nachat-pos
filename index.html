// ----- REPORTS HELPERS -----
function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function endOfDay(d){ const x=new Date(d); x.setHours(23,59,59,999); return x; }

function getUIRange() {
  const preset = document.querySelector('#selPreset')?.value || 'month';
  const fromI  = document.querySelector('#dFrom');
  const toI    = document.querySelector('#dTo');

  if (preset === 'custom') {
    const f = fromI?.value ? startOfDay(fromI.value) : new Date(0);
    const t = toI?.value   ? endOfDay(toI.value)     : new Date(8640000000000000);
    return { from:f, to:t };
  }

  const now = new Date();
  let from, to;

  if (preset === 'today') {
    from = startOfDay(now); to = endOfDay(now);
  } else if (preset === '7d') {
    to = endOfDay(now); from = startOfDay(new Date(now - 6*24*3600*1000));
  } else { // 'month' (default)
    const y = now.getFullYear(), m = now.getMonth();
    from = new Date(y,m,1,0,0,0,0); to = new Date(y,m+1,0,23,59,59,999);
  }

  if (fromI) fromI.value = from.toISOString().slice(0,10);
  if (toI)   toI.value   = to.toISOString().slice(0,10);
  return {from,to};
}

function renderReports() {
  const sales = getSales();                 // <- ของเดิมคุณมีแล้ว
  const {from,to} = getUIRange();

  const rows = sales.filter(s=>{
    const d = new Date(s.createdAt || s.updatedAt || Date.now());
    return d >= from && d <= to;
  });

  // KPIs
  const sum = rows.reduce((a,b)=>a + Number(b.total||0), 0);
  const avg = rows.length ? sum/rows.length : 0;
  document.querySelector('#kpiSum')?.textContent   = '฿'+sum.toLocaleString('th-TH');
  document.querySelector('#kpiBills')?.textContent = rows.length;
  document.querySelector('#kpiAvg')?.textContent   = '฿'+avg.toLocaleString('th-TH');

  // Top สินค้าขายดี
  const map = new Map();
  rows.forEach(r => (r.items||[]).forEach(it=>{
    const k = it.name || it.id;
    map.set(k,(map.get(k)||0)+(Number(it.qty)||1));
  }));
  const top = [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5);
  const ul = document.querySelector('#topList');
  if (ul) ul.innerHTML = top.length
    ? top.map(([n,q])=>`<li><span>${n}</span><b>${q}</b></li>`).join('')
    : '<div class="muted">ยังไม่มีข้อมูล</div>';

  // ตารางบิล
  const box = document.querySelector('#salesTableBox');
  if (box) {
    if (!rows.length) { box.innerHTML = '<div class="muted">ยังไม่มีข้อมูล</div>'; return; }
    box.innerHTML = `
      <table>
        <thead><tr><th>วันที่เวลา</th><th>โต๊ะ</th>
          <th style="text-align:right">ยอดสุทธิ</th><th>ชำระ</th></tr></thead>
        <tbody>
        ${rows.map(r=>{
          const d = new Date(r.createdAt||r.updatedAt).toLocaleString('th-TH');
          const pay = (r.payment?.method||'').toUpperCase();
          return `<tr>
            <td>${d}</td><td>${r.table||'-'}</td>
            <td style="text-align:right">฿${Number(r.total||0).toLocaleString('th-TH')}</td>
            <td>${pay}</td>
          </tr>`;
        }).join('')}
        </tbody>
      </table>`;
  }
}
